<div id="focusedOptions" hidden>
  {% include 'components/parameters/transducers/focused.html' %}
</div>
<div id="planarOptions" hidden>
  {% include 'components/parameters/transducers/planar.html' %}
</div>
<div id="pointOptions" hidden>
  {% include 'components/parameters/transducers/point.html' %}
</div>
<div id="phasedArrayOptions" hidden>
  {% include 'components/parameters/transducers/phased-array.html' %}
</div>
<script>
  let addedTransducers = []

  function getTransducerTitle(transducer){
    const transducerTypes = {{all_transducer_types | tojson | safe}}
    for (let transducerTuple of transducerTypes){
      if (transducerTuple[0] == transducer){
        return transducerTuple[1]
      }
    }
  }

  function showSaveButton(transducerIndex) {
    document.getElementById("saveTransducerButton").removeAttribute("hidden")
    document.getElementById("saveTransducerButton").dataset.transducerId =
      transducerIndex
    document.getElementById("addTransducerButton").setAttribute("hidden", true)
  }

  function hasTransducers() {
    return addedTransducers.length > 0
  }

  function hideSaveButton() {
    document.getElementById("saveTransducerButton").setAttribute("hidden", true)
    document.getElementById("addTransducerButton").removeAttribute("hidden")
  }

  function showForm() {
    document.getElementById("createTransducerForm").removeAttribute("hidden")
    document.getElementById("newTransducerButton").setAttribute("hidden", true)
    document.getElementById("formControls").removeAttribute("hidden")
    cleanTransducerSettings()
  }

  function hideForm() {
    document.getElementById("createTransducerForm").setAttribute("hidden", true)
    document.getElementById("formControls").setAttribute("hidden", true)
    document.getElementById("newTransducerButton").removeAttribute("hidden")
  }

  function cleanTransducerSettings() {
    document.getElementById("transducerSettings").innerHTML = ""
  }

  function addTransducer(button) {
    // Called when button Add at the end of the form is pressed
    if (button.form.checkValidity()){
      storeTransducer()
      hideForm()
      renderLayout()
    } else {
      button.form.reportValidity()
    }

  }

  function newTransducer() {
    // Called when button Add Transducer is pressed
    document.getElementById("transducerType").value = "" // cleaning up selection
    showForm()
    hideSaveButton()
  }

  function saveTransducer(button, transducerIndex) {
    // Called when button Save at the end of the form is pressed
    if (button.form.checkValidity()){
      storeTransducer(transducerIndex)
      renderLayout()
    } else {
      button.form.reportValidity()
    }
  }

  function clearAllTransducers() {
    addedTransducers.splice(0, addedTransducers.length)
    renderAddedTransducers()
  }

  function setTransducersValues(transducers) {
    // Called by the main script to set the transducers values
    addedTransducers.splice(0, addedTransducers.length)

    for (transducer of transducers) {
      addedTransducers.push(transducer)
    }
    transducerAdded()
  }

  function transducerSelected(transducerComponent) {
    // Called when the user changes the value of the <select> component
    let params = null
    let transducerSettingsComponent = document.getElementById(
      "transducerSettings"
    )
    switch (transducerComponent.value) {
      case "focusedSource":
        params = document.getElementById("focusedOptions").innerHTML
        transducerSettingsComponent.innerHTML = params
        break
      case "pointSource":
        params = document.getElementById("pointOptions").innerHTML
        transducerSettingsComponent.innerHTML = params
        break
      case "planarSource":
        params = document.getElementById("planarOptions").innerHTML
        transducerSettingsComponent.innerHTML = params
        break
      case "phasedArraySource":
        params = document.getElementById("phasedArrayOptions").innerHTML
        transducerSettingsComponent.innerHTML = params
        break
      default:
        cleanTransducerSettings()
    }
    transducerSettingsComponent.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (tooltip) {
      // initialize bootstrap tooltips
      $(tooltip).tooltip()
    })
  }

  function getTransducersParams() {
    return addedTransducers
  }

  function transducerAdded() {
    // Called after a transducer is added
    renderAddedTransducers()
    cleanTransducerSettings()

    hideForm()
  }

  function cancelAddTransducer() {
    hideForm()
  }

  function storeTransducer(transducerIndex) {
    let settings = {}

    let formValues = {}
    let formData = new FormData(document.getElementById("createTransducerForm"))
    formData.forEach(function (value, key) {
      formValues[key] = value
    })
    switch (formValues.transducerType) {
      case "focusedSource":
        settings = getFocusedSourceParams(formValues)
        break
      case "planarSource":
        settings = getPlanarSourceParams(formValues)
        break
      case "pointSource":
        settings = getPointSourceParams(formValues)
        break
      case "phasedArraySource":
        settings = getPhasedArraySourceParams(formValues)
        break
    }
    let addTransducer = {
      transducerType: formValues.transducerType,
      ...settings,
    }

    if (transducerIndex) {
      addedTransducers[transducerIndex] = addTransducer
    } else {
      addedTransducers.push(addTransducer)
    }
    transducerAdded()
  }

  function editTransducer(transducerIndex) {
    // Called when edit button of an already added transducer is pressed
    const transducer = addedTransducers[transducerIndex]

    showForm()
    showSaveButton(transducerIndex)
    document.getElementById("transducerType").value = transducer.transducerType
    transducerSelected(document.getElementById("transducerType"))
    switch (transducer.transducerType) {
      case "focusedSource":
        editFocusedSource(transducer)
        break
      case "planarSource":
        editPlanarSource(transducer)
        break
      case "pointSource":
        editPointSource(transducer)
        break
      case "phasedArraySource":
        editPhasedArraySource(transducer)
        break
    }
  }

  function deleteTransducer(transducerIndex) {
    // Called when delete button of an already added transducer is pressed
    addedTransducers.splice(transducerIndex, 1)
    renderAddedTransducers()
    hideForm()
    renderLayout()
  }

  function renderAddedTransducers() {
    const addedTransducersElement = document.getElementById("addedTransducers")
    addedTransducersElement.innerHTML = ""
    const transducerTemplate = document.getElementById(
      "addedTransducerTemplate"
    )
    let index = 0
    for (transducer of addedTransducers) {
      let addTransducer = transducerTemplate.content.cloneNode(true)
      addTransducer.querySelector(".content-title").innerHTML =
        getTransducerTitle(transducer.transducerType)

      addTransducer
        .querySelector('[data-action="edit"]')
        .setAttribute("data-transducer-id", index)

      addTransducer
        .querySelector('[data-action="delete"]')
        .setAttribute("data-transducer-id", index)

      addedTransducersElement.appendChild(addTransducer)
      index++
    }
    // if there are no transducers, disable the run simulation button
    allowRunSimulation()
  }

  function focalLengthCheckClick(input){
    const focalLength = input.form.querySelector("#focalLength")
    if (input.checked){
      document.querySelectorAll('[data-focal-length="true"]').forEach((element) => {
        element.removeAttribute("hidden")
      })
      focalLength.required = true
      focalLength.value = ""
    } else {
      document.querySelectorAll('[data-focal-length="true"]').forEach((element) => {
        element.setAttribute("hidden", true)
      })
      focalLength.removeAttribute("required")
    }
  }
</script>

<template id="addedTransducerTemplate">
  <li class="list-group-item d-flex collapsed">
    <span class="content-title m-1">Title 1</span>

    <div class="ms-auto">
      <span
        class="fa fa-pencil-alt cercle-icons edit-icon"
        data-transducer-id="-1"
        data-action="edit"
        aria-hidden="true"
        onclick="editTransducer(this.dataset.transducerId)"></span>
      <span
        class="far fa-trash-alt cercle-icons delete-icon"
        data-delete-transducer="true"
        data-transducer-id="-1"
        data-action="delete"
        aria-hidden="true"
        onclick="deleteTransducer(this.dataset.transducerId)"></span>
    </div>
  </li>
</template>

<div class="card">
  <ul class="list-group list-group-flush" id="addedTransducers"></ul>
</div>
<br />
<div id="newTransducerButton">
  <fieldset>
    <button class="btn btn-primary" type="button" onclick="newTransducer()">
      Add Transducer
    </button>
  </fieldset>
</div>
<form id="createTransducerForm" hidden>
  <fieldset>
    <div class="mb-3">
      <label for="transducerType" class="form-label">Source Transducer</label>
      <select
        class="form-select"
        id="transducerType"
        name="transducerType"
        onchange="transducerSelected(this)"
        aria-label="Select a transducer">
        <option value selected>-- Select transducer --</option>
        {% for transducerType, transducerTypeLabel in all_transducer_types %}
        <option value="{{transducerType}}">{{transducerTypeLabel}}</option>
        {% endfor %}
      </select>
    </div>
    <div id="transducerSettings"></div>
    <div id="formControls" hidden>
      <button
        type="button"
        class="btn btn-primary btn-block"
        onclick="cancelAddTransducer(this)">
        Cancel
      </button>
      <button
        type="button"
        id="addTransducerButton"
        class="btn btn-primary btn-block"
        onclick="addTransducer(this)">
        Add
      </button>
      <button
        type="button"
        data-transducer-id="-1"
        id="saveTransducerButton"
        class="btn btn-primary btn-block"
        onclick="saveTransducer(this, this.dataset.transducerId)"
        hidden>
        Save Transducer
      </button>
    </div>
  </fieldset>
</form>
